#include <stdint.h>
#include <math.h>
#include <string.h>
#include <float.h>
#include "mex.h"
#include "lapack.h"
#include <sib_basic.h>
#include <sib_oe_conjugate4.h>
#include <sib_basic.h>
typedef uint16_t char16_t;

extern double *teta;
extern double *u;
extern double *ym;
extern double *tetafim;
extern double **H;
extern int du,dteta,num,delay,mode;

extern bool utIsInterruptPending();


void sib_steepest(double* tetafim)
{

    int i,j,k;
    double *tetatemp;
    double *gra;
    double *dir;
    double passo = 0.00001;
    double N;
    double J1[1];
    double J2[1];

    tetatemp=malloc((dteta)*sizeof(double));
    gra=malloc((dteta)*sizeof(double));
    dir=malloc((dteta)*sizeof(double));
    
    memcpy(tetafim,teta,sizeof(double) *dteta);

    for(i=0; i<100; i++)
    {

        for(j=0; j<1000; j++)
        {   
            mode=1;
            grad(tetafim,dteta,delay,num,u,du,ym,J1,gra);
    
            if((i==0)&(j==0))
            {
                memcpy(dir,gra,sizeof(double)*dteta);
            }

            for (k = 0; k < dteta; k++)
            {
                dir[k] = (4*dir[k]+gra[k])/5;
            }
    
            N = norm(dir,dteta); 

            for (k = 0; k < dteta; k++)
            {
                tetatemp[k] = tetafim[k] - passo*dir[k]/N;
            }

            mode=0;
            grad(tetatemp,dteta,delay,num,u,du,ym,J2,gra);

            if (J2[0]>J1[0])
            {
                passo=passo*0.99;

            }else{   
                passo=passo*1.01;
                memcpy(tetafim,tetatemp,sizeof(double) *dteta);
            }
    
        }    
    
        mexPrintf("G: ");
        for (k = 0; k < (int)floor(i/5); k++)
        {
            mexPrintf("#");
        }
        for (k = (int)floor(i/5); k < 20; k++)
        {
            mexPrintf("-");
        }
        mexPrintf(" %d\% 1.10f %1.10f \n",i,J1[0],passo);
        mexEvalString("drawnow;");

        

        if (passo<0.0000001)
        {
            break;
        }    
    }

    free(tetatemp);
    free(gra);
    free(dir);

}
 



void sib_newton(double* tetafim)
{

    int i,j,k;
    double *tetatemp;
    double *gra;
    double *dir;
    double passo;
    double N;
    double J1[1];
    double J2[1];

    double A[16] = {1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1};

    long Ns = 4;
    long Ms = 1;

    long ipiv[4];
    long info;


    tetatemp=malloc((dteta)*sizeof(double));
    gra=malloc((dteta)*sizeof(double));
    dir=malloc((dteta)*sizeof(double));

    memcpy(tetafim,teta,sizeof(double) *dteta);


    for(i=0;i<100;i++)
    {
        mode=2;
        grad(tetafim,dteta,delay,num,u,du,ym,J1,gra);
/*
        mexPrintf("G: \n");

        mexPrintf("%1.10f %1.10f %1.10f %1.10f\n",gra[0],gra[1],gra[2],gra[3]);
        
        mexPrintf("H: \n");
        mexPrintf("%1.10f %1.10f %1.10f %1.10f\n",H[0][0],H[0][1],H[0][2],H[0][3]);
        mexPrintf("%1.10f %1.10f %1.10f %1.10f\n",H[1][0],H[1][1],H[1][2],H[1][3]);
        mexPrintf("%1.10f %1.10f %1.10f %1.10f\n",H[2][0],H[2][1],H[2][2],H[2][3]);
        mexPrintf("%1.10f %1.10f %1.10f %1.10f\n",H[3][0],H[3][1],H[3][2],H[3][3]);
*/        
        dgesv(&Ns, &Ms, *H, &Ns, ipiv, gra, &Ns, &info);
//        mexPrintf("%1.10f %1.10f %1.10f %1.10f\n",gra[0],gra[1],gra[2],gra[3]);

    
        for (k = 0; k < dteta; k++)
        {
            tetatemp[k] = tetafim[k] - gra[k];
        }
    
        memcpy(tetafim,tetatemp,sizeof(double) *dteta);
    
        mexPrintf("N: ");
        for (k = 0; k < (int)floor(i/5); k++)
        {
            mexPrintf("#");
        }
        for (k = (int)floor(i/5); k < 20; k++)
        {
            mexPrintf("-");
        }
        mexPrintf(" %d\%  %1.10f \n",i,J1[0]);
        mexEvalString("drawnow;");
        
        
        if (utIsInterruptPending()) {       
            mexPrintf("Ctrl-C Detected. END\n\n");
            return;
        }
        

    }

    free(tetatemp);
    free(gra);
    free(dir);

}
 


